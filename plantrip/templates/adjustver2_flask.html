<!DOCTYPE html>
<html>
<head>
<title>Bootstrap 4 Example</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<script src="https://kit.fontawesome.com/80f6c102d9.js" crossorigin="anonymous"></script>
<link href="https://fonts.googleapis.com/css?family=Dancing+Script|Indie+Flower|Lobster|Pacifico|Slabo+27px|Noto+Sans+TC:300&display=swap" rel="stylesheet">
<link type="text/css" rel="stylesheet" href="{{ url_for('static', filename='css/materialize.min.css') }}"  media="screen,projection"/>
<style>
body{
	margin:0;
	background-color: #fff;
}
h3{
	text-align: center;
	margin:10px 0px;
	margin-left: 5px;
	font-size: 20px;
}
h2{
	width: 100%;
	text-align: center;
	padding: 0;
	margin: 0;
	background: #FFD4CD;

}

.fa-angle-left{
	float: left;
	margin-top: 1%;
	font-size: 20px;
}
.add button{
	color: #F8A588;
	border: none;
}
.container-fluid{
	margin-top: 10px;
	margin-bottom: 10px;
}
.date2{
	height: 20%;
	margin-top: 10px;
	padding: 5px;
	background-color: #FFF396;
}
.date2 div{
	margin: auto;
	width: 85%;
	border: 2px solid #ffffff;
	background-color: #f5f5f5;
	border-radius: 10px;
}
.fa-edit{
	margin: 10px 10px 10px;
	font-size: 25px;
}
.add{
	vertical-align: top;
    padding-top: 4px;
    padding-left: 5px;
	top: 8px;
	display: inline-block;
	height: 43px;
	white-space:nowrap; /*元素不換行*/
	overflow-x: auto;
	overflow-y: hidden; 		
}
.date2 .add{
	margin-top: 1px;
	margin-left: 2px
}

.date2 .day{
	margin-left: 1px ;  
	margin-top: 1px ;
	padding: 5px 10px;
	background-color: #F8A588;
	color: #ffffff;
	border-radius: 10px;
	font-size: 18px;
	font-family: 'Noto Sans TC', sans-serif;
	
}
.fa-plus{
	padding: 5px;
	color: #F8A588;
	border-radius: 5px;
	background-color: #ffffff;
	font-size: 20px;
}
.fa-plus:active{
	background-color: #e0e0e0;
}

.add_move{
	animation-name: addmove; 	
	animation-duration: 2s;	 
	animation-fill-mode: forwards;
}
@keyframes addmove {
	from{
		transform: translateX(0px);
	}

	to{
		transform: translateX(20px);
	}
}

.container2{
	overflow: auto;
	padding: 10px;
	position: relative;
	background-color: #f5f5f5;
}

.line::before{
	content: "";
	width:3px;
	height: 100%;
	top:0px;
	left: 6.5%;
	background-color: #e0e0e0;
	position: absolute;
}

.content2{
	/*background-color: #FFEDCE;*/
	background-color: #FFF396;
	padding: 5px 5px;
	margin-left: 13%;
	width: 85%;
	border-radius: 8px;
}
.content2::before{
	display: inline-block;
	content: "";
	width: 15px;
	height: 15px;
	top: 25%;
	left: 4.7%;
	border-radius: 10px;
	background: #e0e0e0;
	position: absolute;	
	transform: translateY(-50%);
}

.glyphicon-move {
	cursor: move;
	cursor: -webkit-grabbing;
}
* { 
	touch-action: auto;
}
h4{
	margin-bottom: 2px;
	font-size: 20px;
	font-family: 'Noto Sans TC', sans-serif;
}
.list-group{
    display:flex;
    flex-direction: column;
    margin-bottom: 0;
}
.list-group-item{
    position:relative;
    display:block;
    padding:0.75rem 1.25rem;
    background-color: #FFF;
	border: none;
}
.pickdate2{
    display: inline-block;
	text-align: center;
	width:32.5%;
}
.pickdate{
    display: inline-block;
	text-align: center;
	width:32.5%;
}
.pickdate2:active{
	transform: scale(0.8, 0.8);
	color: #F8A588;
}
.pickdate2 input:active{
	transform: scale(0.8, 0.8);
	color: #F8A588;
}
.fa-calendar-alt{
    display: block;
	margin-top: 10px ;
	margin-left: 12px;
	margin-right: 12px;
    font-size: 23px;
}
.fa-clock, .fa-map-marker-alt{
	display: block;
	margin-top: 10px ;
	margin-left: 12px;
	margin-right: 12px;
	margin-bottom: 3px;
	font-size: 23px;
}

.glyphicon-move p{
	position: relative;
	width: 85%;
	top: 5%;
	left: 15%;
}
.footer button{
	margin: 5% 15%;
	background-color: #f5f5f5;
	color: #000000;
	border-radius: 10px;
	width: 70%;
	height: 40px;
}

.footer{
	background-color: #fff;

	position: fixed;
	bottom: 0;
	width:100%;
}
.footer button{
	color: #F8A588;
	border: none;
}
.footer button:active{
	background-color: #FFEDCE;
}
#fixed_wrap {
	
    height: 80px;
    background-color: #f5f5f5;
}
#timebar{
	margin-bottom: 5px;
}
/* The Modal (background) */

::placeholder { /* Chrome, Firefox, Opera, Safari 10.1+ */
  color: black;
  opacity: 1; /* Firefox */
}
#name{
	background-color: #fff;
	font-size: 20px;
	color: #F8A588;
	text-align: center;
	margin-top: 10px;
	margin-bottom: 10px;
}

input{
	border-style: none!important;
	width:100px!important;
	margin:0!important;
	font-size: 15px!important;
    text-align: center;
    height:25px!important;
}

input[type=text]:not(.browser-default):focus:not([readonly]){
    box-shadow:none;
    -webkit-box-shadow:none;
    border-bottom:none;
}

.datepicker-date-display,.timepicker-digital-display{
    background-color:#fff396;

}
.datepicker-cancel,.datepicker-done,.timepicker-close,.timepicker-svg,.timepicker-minutes{
    color:#fff396;
}

#map{
	height:300px;
}
#mode{
	display:flex;
	flex-wrap:wrap;
	flex-flow:row;
	justify-content: center;
	padding:5px;
	margin-top: 5px;
}
#mode .fas{
	padding-left:5px;
	flex: 1 1 100px;
	font-size: 30px;
}

#mode .fa-walking , #mode .fa-bus{
	font-size: 30px;
	padding-left: 20px;
}
</style>
</head>
<body>

<div class="container-fluid">
	<i class="fas fa-angle-left" onclick="change()"></i>
    <h3>Adjust Your Schedule</h3>
</div>
<div class="edit">
	<div id="name">
	<i id="edit_name" class="fas fa-pen"></i>
    </div>
	<div class="date2">
		<i class="fas fa-edit"></i>
		<div class="add">
			<button id="1" type="button" class="day">第1天</button>
			<i id="plus" class="fas fa-plus" onclick="add_date()"></i>
		</div>
	</div>
	<div id="timebar">
		<div class="pickdate">
			<i class="fas fa-calendar-alt"></i>
			<input id="time_date" type="text" class="datepicker" placeholder="123456">
            <!--<span id="time_date"></span>-->
            <!--<input id="date-input" type="text" class="datedropper-init">-->
		</div>
		<div class="pickdate">
			<i class="fas fa-clock"></i>
            <!--<span id="time_time"></span>-->
            <input id="time_time" type="text" class="timepicker" placeholder="126546">
		</div>
		<div class="pickdate2">
			<i class="fas fa-map-marker-alt"></i>
            <!--<span id="mappp">Map</span>-->
            <a class="modal-trigger" href="#modal1" id="mappp">Map</a>
		</div>
    </div>

    <!-- Modal Structure -->
    <div id="modal1" class="modal">
        <div class="modal-content">
			<h4>Mode of Travel:</h4>
			<div id='mode'>
				<i id="DRIVING" class="fas fa-car-side"></i>
				<i id="WALKING" class="fas fa-walking"></i>
				<i id="BICYCLING" class="fas fa-biking"></i>
				<i id="TRANSIT" class="fas fa-bus"></i>
			</div>
        </div>
        <div id="map"></div>
        <div class="modal-footer">
        <a href="#!" class="modal-close waves-effect waves-green btn-flat">Agree</a>
        </div>
    </div>
	
	<div id="listWithHandle" class="container2 list-group">
		<!--
		<div id="div1" class="line list-group-item">
			<div class="glyphicon-move">
				<h4 class="content">10min</h4>
				<p>Loreornfacilisis . Duis sagittis ligula in sodales vehicula....</p>
			</div>
		</div>
		<div id="div2" class="line list-group-item">
			<div class="glyphicon-move">
				<h4 class="content">20min</h4>
				<p>Loreornfacilisis . Duis sagittis ligula in sodales vehicula....</p>
			</div>
		</div>
		<div id="div3" class="line list-group-item">
			<div class="glyphicon-move ">
				<h4 class="content">30min</h4>
				<p>Loreornfacilisis . Duis sagittis ligula in sodales vehicula....</p>
			</div>
		</div>
		<div id="div4" class="line list-group-item">
			<div class="glyphicon-move">
				<h4 class="content">40min</h4>
				<p>Loreornfacilisis . Duis sagittis ligula in sodales vehicula....</p>
			</div>
		</div>
		<div id="div4" class="line list-group-item">
			<div class="glyphicon-move">
				<h4 class="content">40min</h4>
				<p>Loreornfacilisis . Duis sagittis ligula in sodales vehicula....</p>
			</div>
		</div>
	-->
	</div>
	
<div id="dataid" d="{{rec}}" style="display:none"></div>
</div>
<div id="fixed_wrap">
	<div class="footer">
		<button id="save">Save</button>
	</div>
</div>


<!--
<script src="https://cdn.datedropper.com/get/af28bae6oeqgrs87myyndn94auqpe2qx"></script>
-->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.6.1/Sortable.min.js"></script>
<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="{{ url_for('static', filename='js/materialize.js') }}"></script>
<script src="{{ url_for('static', filename='js/init.js') }}"></script>
<!--<script src="./datedropper.pro.min.js"></script>-->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC_crn8-2St09n9dRSmb7GBD85Qaxkd8G0"></script>
<script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-database.js"></script>
<script src="{{ url_for('static', filename='js/database_setup.js') }}"></script>
<script>
	function change(){
		window.location.href="https://ithelp.ithome.com.tw/articles/10205961";
	}

    var dt = new Date();
    var month = new Array(12);
    month[0] = "01";
    month[1] = "02";
    month[2] = "03";
    month[3] = "04";
    month[4] = "05";
    month[5] = "06";
    month[6] = "07";
    month[7] = "08";
    month[8] = "09";
    month[9] = "10";
    month[10] = "11";
    month[11] = "12";

    function time_check(x){
        if(x.toString().length != 1){
            return (x);
        }
        else{
            return ('0'+ x.toString()[0]);
        }
    } 
    
    document.getElementById('time_date').setAttribute('placeholder',dt.getFullYear()+"-"+month[dt.getMonth()]+"-"+time_check(dt.getDate()));
	document.getElementById('time_time').setAttribute('placeholder',time_check(dt.getHours())+":"+time_check(dt.getMinutes()));

    var name = '{{region}}';
	console.log(name);
	document.getElementById('name').insertAdjacentHTML('afterbegin',name);
	var js_data = document.getElementById('dataid').getAttribute('d');
	var empty = ''
	for(var i=0;i<js_data.length;i++){
		if(i==0 || i==js_data.length-1||js_data[i] == "'"||js_data[i] == " "){
			console.log(i)
			continue;
		}else{
			empty += js_data[i]
		}
	}
	var json_data = empty.split(',')
	console.log(empty)
	console.log(typeof js_data)
	
	console.log(json_data)

    var itemlength = json_data.length;
    console.log(itemlength);


	var myMap = new Map();
	var mapdistance = new Map();
	
	console.log(name)
	console.log(json_data[0])
	
	function getdatabefore(i){
		
			dbtest.ref('attraction/'+name+'/'+json_data[i]+'/詳細地點資訊/').on('value', function (snapshot) {
				var data = snapshot.val();
				console.log(data['經度']);
				console.log(data['緯度']);		
				myMap.set("div"+(i+1).toString(),[data['經度'],data['緯度']]);
				console.log(myMap)
				mapdistance.set(json_data[i],[data['經度'],data['緯度']]);
				console.log(mapdistance)
				distance(distanceservice);
			});
	}

	function test(){
		for(var i=0; i<itemlength;i++){
			
			document.getElementById('listWithHandle').insertAdjacentHTML('beforeend',
			`<div id="div${i+1}" class="line list-group-item">
				<div class="glyphicon-move">
					<h4 class="content2">${json_data[i]}</h4>
					<p id="p_${i+1}">Loreornfacilisis . Duis sagittis ligula in sodales vehicula....</p>
				</div>
			</div>`)
			getdatabefore(i);
		}
	}

	document.getElementById('listWithHandle').addEventListener('load',test());
	console.log(myMap);
	console.log(mapdistance);
	

    function calculateAndDisplayRoute(directionsService, directionsRenderer, mode) {
        var waypts = [];
        var checkboxArray = document.getElementById('listWithHandle').children; //list-item數目-2
        for (var i = 0; i < (checkboxArray.length)-2; i++) {
            waypts.push({
                location: {lng:parseFloat(myMap.get(checkboxArray[i+1].id)[0]),lat:parseFloat(myMap.get(checkboxArray[i+1].id)[1])},
                stopover: true
            }); 
        }

        directionsService.route({
            origin: {lng:parseFloat(myMap.get(checkboxArray[0].id)[0]),lat:parseFloat(myMap.get(checkboxArray[0].id)[1])},
            destination: {lng:parseFloat(myMap.get(checkboxArray[(checkboxArray.length)-1].id)[0]),lat:parseFloat(myMap.get(checkboxArray[(checkboxArray.length)-1].id)[1])},
            waypoints: waypts,
            optimizeWaypoints: true,
            travelMode: mode
        }, function(response, status) {
            if (status === 'OK') {
            	directionsRenderer.setDirections(response);
            } 
			else {
            	window.alert('Directions request failed due to ' + status);
            }
        });
	}
	
	function distance(directionsService){	
		var checkboxArray = document.getElementById('listWithHandle').children;
		console.log(checkboxArray)
		var waypts = [];
		for (var i = 0; i < checkboxArray.length; i++){
			console.log(myMap.get(checkboxArray[i].id))
			waypts.push({lng:parseFloat(myMap.get(checkboxArray[i].id)[0]),lat:parseFloat(myMap.get(checkboxArray[i].id)[1])});	
		}
		console.log(waypts);

		directionsService.getDistanceMatrix({
			origins: waypts,
			destinations: waypts,
			travelMode: 'DRIVING',
			unitSystem: google.maps.UnitSystem.METRIC,
			avoidHighways: false,
			avoidTolls: false
		}, function(response, status) {
			if (status !== 'OK') {
				alert('Error was: ' + status);
			} 
			else {
				var originList = response.originAddresses;
				var destinationList = response.destinationAddresses;
				
				for (var j = 0 ; j < originList.length; j++){
					var outputDiv = document.getElementById('p_'+(j+1).toString());
					console.log(outputDiv);
					outputDiv.innerHTML = '';
				}
				
				var distanceSeq = document.querySelectorAll('div.glyphicon-move > p');
				var nameSeq = document.querySelectorAll('h4.content2');
				console.log(distanceSeq[0]);
				console.log(distanceSeq[1]);
				console.log(distanceSeq[2]);
				console.log(nameSeq[0].innerText);
				console.log(nameSeq[1]);
				console.log(nameSeq[2]);
				for (var i = 0; i < originList.length; i++) {
					var outputDiv = distanceSeq[i];
					console.log(outputDiv);
					
					if( i != originList.length-1 ){
						var results = response.rows[(distanceSeq[i].id).split('_')[1]-1].elements[(distanceSeq[i+1].id).split('_')[1]-1];
						outputDiv.innerHTML = nameSeq[i].innerText + ' to ' + nameSeq[i+1].innerText + ': <br> 距離 : ' + results.distance.text + ' 時間 : ' + results.duration.text;
					    console.log(outputDiv);
					}
					else{
						outputDiv.innerHTML = '最後一個行程'+ nameSeq[i].innerText +' : <br> 祝您有個美好的Ending'
						console.log(outputDiv);
					}
				}
			}
			
			}	
		);
	}

    var distanceservice = new google.maps.DistanceMatrixService;
	var directionsService = new google.maps.DirectionsService;
	var directionsRenderer = new google.maps.DirectionsRenderer;
	var map = new google.maps.Map(document.getElementById('map'), {
		zoom: 6,
		center: {lat: 41.85, lng: -87.65}
	});
	directionsRenderer.setMap(map);
	document.getElementById('mappp').addEventListener('click', function() {
		calculateAndDisplayRoute(directionsService, directionsRenderer,'DRIVING');
	});

	document.getElementById('mode').addEventListener('click',function(e){
		var selectmode = e.target.id;
		console.log(selectmode);
		calculateAndDisplayRoute(directionsService, directionsRenderer, selectmode);
	});
	

	let date = 1; 
	var number = document.getElementById(date);
	var plusbtn = document.getElementById("plus");
	
	function temp(){	
		plusbtn.style.animation = 'addmove 2s both';
	}
	
	function add_date(){
		var number = document.getElementById(date);
		var btn = document.createElement('button');
		plusbtn.style.transform='translateX(10px)';
		
		date += 1 ;
		btn.setAttribute('id',date);
		btn.setAttribute('type', 'button');
		btn.setAttribute('class', 'day');
		btn.innerHTML = '第'+date+'天'; 
		number.after(btn);
		
	}

	// List with handle
	Sortable.create(listWithHandle, {
		handle: '.glyphicon-move',
		animation: 150,
		preventOnFilter: false,
		onUpdate: function(evt){
			console.log(evt);
			distance(distanceservice);
		}
	});


	function save(key){
	
		var timedate = document.getElementById('time_date').getAttribute('placeholder'); //日期
		console.log(time_date);
        var name = '{{region}}';
		console.log(name);
		var timetime = document.getElementById('time_time').getAttribute('placeholder'); //日期
		console.log(timetime)
		var schedule = document.querySelectorAll('h4.content2');//行程順序
		var scheduleseq = [];
		for(var i=0;  i < schedule.length; i++) {
			var output = schedule[i].innerText;
			console.log(output);
			scheduleseq.push(output);
		}
		console.log(scheduleseq);
		var distanceSeq = document.querySelectorAll('div.glyphicon-move > p');
		var content = [];
		for(var i=0;  i < distanceSeq.length; i++) {
			var output = distanceSeq[i].innerText;
			console.log(output);
			content.push(output);
		}
		console.log(content);
		var itemlength = json_data.length;
		
		console.log(mapdistance)
		var lnglat = [];
		for(var i=0; i<itemlength;i++){
			lnglat.push(json_data[i]+','+mapdistance.get(json_data[i])[0]+','+mapdistance.get(json_data[i])[1]);
			console.log(json_data[i])
			console.log(mapdistance.get(json_data[i])[0]);
			console.log(mapdistance.get(json_data[i])[1]);
		}
		
		
		dbtest.ref('users/'+key+'/planset/'+name).set({date:timedate,time:timetime,schedule:scheduleseq,content:content,lnglat:lnglat});
		location.href = 'http://127.0.0.1:5500/plantrip/plancollection-ex.html'
			
	}
	
	document.getElementById('save').addEventListener('click',function(){
		dbtest.ref("/temprec").once('value', function (snapshot) {
			var data = snapshot.val();
			console.log(data['flaskkey'])
			save(data['flaskkey'])
		});
		//save();
	});
</script>

</body>
</html>